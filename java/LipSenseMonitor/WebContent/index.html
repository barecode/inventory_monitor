<!doctype html>
<html>
<head>
<script>

function calculateMinutesFromMillis(milliseconds) {
	var seconds = Math.floor(milliseconds / 1000);
	var minutes = Math.floor(seconds / 60);
	console.log('milliseconds='+milliseconds);
	console.log('seconds='+seconds);
	console.log('minutes='+minutes);
	if (minutes < 1) {
		return '<1 minute';
	} else if (minutes == 1) {
		return '1 minute';
	} else {
		return minutes+' minutes';
	}
}

function processWatchedClick(clickedItem) {
	var itemNumber = clickedItem.substring(8);
	var distSelect = document.getElementById('distributorSelect');
	var distID = distSelect.options[distSelect.selectedIndex].value;
	var watched = document.getElementById(clickedItem);
	
	if (watched.innerHTML === '<b>watched</b>') {
		watched.innerHTML = '<i>watch</i>';
		var req_delete = new XMLHttpRequest();
		req_delete.onreadystatechange = function() {
			if (req_delete.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_delete.status === 200) {
					// Perfect!
					console.log(req_delete);
					console.log(req_delete.responseText);
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_delete.open('DELETE', '/LipSenseMonitor/rest/wishlists/'+distID+'/'+itemNumber);
		req_delete.send();
		
	} else {
		watched.innerHTML = '<b>watched</b>';
		
		var req_post = new XMLHttpRequest();
		req_post.onreadystatechange = function() {
			if (req_post.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_post.status === 200) {
					// Perfect!
					console.log(req_post);
					console.log(req_post.responseText);
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_post.open('POST', '/LipSenseMonitor/rest/wishlists/'+distID);
		req_post.setRequestHeader('Content-Type', 'application/json');
		req_post.send(itemNumber);
	}
}

function processNotifiedClick(clickedItem) {
	var itemNumber = clickedItem.substring(9);
	var distSelect = document.getElementById('distributorSelect');
	var distID = distSelect.options[distSelect.selectedIndex].value;
	var notified = document.getElementById(clickedItem);
	if (notified.innerHTML === '<b>notified</b>') {
		// Clean isNotified
		notified.innerHTML = '';
		
		var req_put = new XMLHttpRequest();
		req_put.onreadystatechange = function() {
			if (req_put.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_put.status === 200) {
					// Perfect!
					console.log(req_put);
					console.log(req_put.responseText);
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_put.open('PUT', '/LipSenseMonitor/rest/wishlists/'+distID+'/'+itemNumber);
		req_put.send();
	}
}

	window.onload = function updatePage() {
		document.getElementById('updatedTime').innerHTML = "UPDATED";

		var req_distributors = new XMLHttpRequest();
		req_distributors.onreadystatechange = function() {
			if (req_distributors.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_distributors.status === 200) {
					// Perfect!
					console.log(req_distributors);
					console.log(req_distributors.responseText);
					var distSelect = document.getElementById('distributorSelect');
					var distList = JSON.parse(req_distributors.responseText);
					for (var i = 0; i < distList.length; i++) {
					    var distID = distList[i];
					    distSelect.innerHTML += '<option value="'+distID+'">'+distID+'</option>';
					}
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_distributors.open('GET', '/LipSenseMonitor/rest/wishlists/distributors');
		req_distributors.send();
		
		var req_wishlist = new XMLHttpRequest();
		req_wishlist.onreadystatechange = function() {
			if (req_wishlist.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_wishlist.status === 200) {
					// Perfect!
					console.log(req_wishlist);
					console.log(req_wishlist.responseText);
					
					var distSelect = document.getElementById('distributorSelect');
					var distID = distSelect.options[distSelect.selectedIndex].value;
					
					console.log(distID);
					var wishlist = JSON.parse(req_wishlist.responseText);
					console.log(wishlist);
					var list = wishlist[distID].list;
					console.log(list);
					for(var i = 0; i < list.length; i++) {
						var item = list[i];
						console.log(item);
						var watched = document.getElementById('watched-'+item.itemNumber);
						var notified = document.getElementById('notified-'+item.itemNumber);
						watched.innerHTML = (item.isWatched ? '<b>watched</b>' : '<i>watch</i>');
						notified.innerHTML = (item.isNotified ? '<b>notified</b>' : '');
					}
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_wishlist.open('GET', '/LipSenseMonitor/rest/wishlists');
		
		var req_inventory = new XMLHttpRequest();
		req_inventory.onreadystatechange = function() {
			if (req_inventory.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_inventory.status === 200) {
					// Perfect!
					console.log(req_inventory);
					console.log(req_inventory.responseText);
					var updatedTime = document.getElementById('updatedTime');
					var inventory = document.getElementById('inventory');
					
					var inv = JSON.parse(req_inventory.responseText);
					console.log(inv);
					console.log(inv.epochAtLastUpdate);
					var milliseconds = (new Date).getTime();
					console.log(milliseconds);
					var d = new Date(0); // The 0 there is the key, which sets the date to the epoch
					d.setUTCSeconds();
					updatedTime.innerHTML = calculateMinutesFromMillis(milliseconds-inv.epochAtLastUpdate);
					
					var newHTML = '';
					var categories = inv.categories;
					for (var i = 0; i < categories.length; i++) {
					    var cat = categories[i];
					    // Open div
					    newHTML += '<div>';
					    
					    // Create category header
					    newHTML += '<h2>'+cat.name+'</h2><table><thead><tr><th>Item #</th><th>Description</th><th>Availability</th><th>Watched?</th><th>Notified?</th></tr></thead><tbody>';
					    
					    // Create item list
					    var items = cat.items;
					    for (var j = 0; j < items.length; j++) {
					    	var item = items[j];
					    	var stockText = (item.isInStock ? 'In Stock' : 'Out of Stock');
					    	var tableRow = '<tr><td>'+item.itemNumber+'</td><td>'+item.name+'</td><td>'+stockText+'</td><td><span id="watched-'+item.itemNumber+'" onclick="processWatchedClick(\'watched-'+item.itemNumber+'\')"><i>watch<i></span></td><td><span id="notified-'+item.itemNumber+'" onclick="processNotifiedClick(\'notified-'+item.itemNumber+'\')"></span></td></tr>';
					    	console.log(tableRow);
					    	newHTML += tableRow;
					    }
					    
					    // Close div
					    newHTML += '</tbody></table></div>';
					    
					    console.log(newHTML);
					    inventory.innerHTML = newHTML;
					    
						// Wishlist needs to be processes after inventory is
						req_wishlist.send();
					}
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_inventory.open('GET', '/LipSenseMonitor/rest/inventory');
		req_inventory.send();
	}
</script>
</head>
<body>

	<div id="distributorSelection">
		Select the Distributor Wishlist: <select id="distributorSelect"></select>
	</div>

	<div id="updated">
		Last updated <span id="updatedTime"></span> ago. (Updates every 30min).
	</div>

	<div id="inventory"></div>

</body>
</html>