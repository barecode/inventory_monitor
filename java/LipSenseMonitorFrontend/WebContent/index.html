<!doctype html>
<html>
<head>
<script>

function calculateMinutesFromMillis(milliseconds) {
	var seconds = Math.floor(milliseconds / 1000);
	var minutes = Math.floor(seconds / 60);
	console.log('milliseconds='+milliseconds);
	console.log('seconds='+seconds);
	console.log('minutes='+minutes);
	if (minutes < 1) {
		return '<1 minute';
	} else if (minutes == 1) {
		return '1 minute';
	} else {
		return minutes+' minutes';
	}
}

function processWatchedClick(clickedItem) {
	var itemNumber = clickedItem.substring(8);
	var distSelect = document.getElementById('distributorSelect');
	var distID = distSelect.options[distSelect.selectedIndex].value;
	var watched = document.getElementById(clickedItem);
	
	if (watched.innerHTML === '<svg currentScale="1" width="30px" height="30px" viewBox="0 0 210 150"><use xlink:href="#open-eye"/></svg>') {
		watched.innerHTML = '<svg currentScale="1" width="30px" height="30px" viewBox="0 -30 210 150"><use xlink:href="#closed-eye"/></svg>';
		var req_delete = new XMLHttpRequest();
		req_delete.onreadystatechange = function() {
			if (req_delete.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_delete.status === 200) {
					// Perfect!
					console.log(req_delete);
					console.log(req_delete.responseText);
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_delete.open('DELETE', '/LipSenseMonitor/rest/wishlists/'+distID+'/'+itemNumber);
		req_delete.send();
		
	} else {
		watched.innerHTML = '<svg currentScale="1" width="30px" height="30px" viewBox="0 0 210 150"><use xlink:href="#open-eye"/></svg>';
		
		var req_post = new XMLHttpRequest();
		req_post.onreadystatechange = function() {
			if (req_post.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_post.status === 200) {
					// Perfect!
					console.log(req_post);
					console.log(req_post.responseText);
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_post.open('POST', '/LipSenseMonitor/rest/wishlists/'+distID);
		req_post.setRequestHeader('Content-Type', 'application/json');
		req_post.send(itemNumber);
	}
}

function processNotifiedClick(clickedItem) {
	var itemNumber = clickedItem.substring(9);
	var distSelect = document.getElementById('distributorSelect');
	var distID = distSelect.options[distSelect.selectedIndex].value;
	var notified = document.getElementById(clickedItem);
	if (notified.innerHTML === '<b>notified</b>') {
		// Clean isNotified
		notified.innerHTML = '';
		
		var req_put = new XMLHttpRequest();
		req_put.onreadystatechange = function() {
			if (req_put.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_put.status === 200) {
					// Perfect!
					console.log(req_put);
					console.log(req_put.responseText);
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_put.open('PUT', '/LipSenseMonitor/rest/wishlists/'+distID+'/'+itemNumber);
		req_put.send();
	}
}

	window.onload = function updatePage() {
		document.getElementById('updatedTime').innerHTML = "UPDATED";

		var req_distributors = new XMLHttpRequest();
		req_distributors.onreadystatechange = function() {
			if (req_distributors.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_distributors.status === 200) {
					// Perfect!
					console.log(req_distributors);
					console.log(req_distributors.responseText);
					var distSelect = document.getElementById('distributorSelect');
					var distList = JSON.parse(req_distributors.responseText);
					for (var i = 0; i < distList.length; i++) {
					    var distID = distList[i];
					    distSelect.innerHTML += '<option value="'+distID+'">'+distID+'</option>';
					}
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_distributors.open('GET', '/LipSenseMonitor/rest/wishlists/distributors');
		req_distributors.send();
		
		var req_wishlist = new XMLHttpRequest();
		req_wishlist.onreadystatechange = function() {
			if (req_wishlist.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_wishlist.status === 200) {
					// Perfect!
					console.log(req_wishlist);
					console.log(req_wishlist.responseText);
					
					var distSelect = document.getElementById('distributorSelect');
					var distID = distSelect.options[distSelect.selectedIndex].value;
					
					console.log(distID);
					var wishlist = JSON.parse(req_wishlist.responseText);
					console.log(wishlist);
					var list = wishlist[distID].list;
					console.log(list);
					for(var i = 0; i < list.length; i++) {
						var item = list[i];
						console.log(item);
						var watched = document.getElementById('watched-'+item.itemNumber);
						var notified = document.getElementById('notified-'+item.itemNumber);
						watched.innerHTML = (item.isWatched ? '<svg currentScale="1" width="30px" height="30px" viewBox="0 0 210 150"><use xlink:href="#open-eye"/></svg>' : '<svg currentScale="1" width="30px" height="30px" viewBox="0 -30 210 150"><use xlink:href="#closed-eye"/></svg>');
						notified.innerHTML = (item.isNotified ? '<b>notified</b>' : '');
					}
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_wishlist.open('GET', '/LipSenseMonitor/rest/wishlists');
		
		var req_inventory = new XMLHttpRequest();
		req_inventory.onreadystatechange = function() {
			if (req_inventory.readyState === XMLHttpRequest.DONE) {
				// Everything is good, the response was received.
				if (req_inventory.status === 200) {
					// Perfect!
					console.log(req_inventory);
					console.log(req_inventory.responseText);
					var updatedTime = document.getElementById('updatedTime');
					var inventory = document.getElementById('inventory');
					
					var inv = JSON.parse(req_inventory.responseText);
					console.log(inv);
					console.log(inv.epochAtLastUpdate);
					var milliseconds = (new Date).getTime();
					console.log(milliseconds);
					var d = new Date(0); // The 0 there is the key, which sets the date to the epoch
					d.setUTCSeconds();
					updatedTime.innerHTML = calculateMinutesFromMillis(milliseconds-inv.epochAtLastUpdate);
					
					var newHTML = '';
					var categories = inv.categories;
					for (var i = 0; i < categories.length; i++) {
					    var cat = categories[i];
					    // Open div
					    newHTML += '<div>';
					    
					    // Create category header
					    newHTML += '<h2>'+cat.name+'</h2><table><thead><tr><th>Item #</th><th>Description</th><th>Availability</th><th>Watched?</th><th>Notified?</th></tr></thead><tbody>';
					    
					    // Create item list
					    var items = cat.items;
					    for (var j = 0; j < items.length; j++) {
					    	var item = items[j];
					    	var stockText = (item.isInStock ? 'In Stock' : 'Out of Stock');
					    	var tableRow = '<tr><td>'+item.itemNumber+'</td><td>'+item.name+'</td><td>'+stockText+'</td><td><span id="watched-'+item.itemNumber+'" onclick="processWatchedClick(\'watched-'+item.itemNumber+'\')"><i>watch<i></span></td><td><span id="notified-'+item.itemNumber+'" onclick="processNotifiedClick(\'notified-'+item.itemNumber+'\')"></span></td></tr>';
					    	console.log(tableRow);
					    	newHTML += tableRow;
					    }
					    
					    // Close div
					    newHTML += '</tbody></table></div>';
					    
					    console.log(newHTML);
					    inventory.innerHTML = newHTML;
					    
						// Wishlist needs to be processes after inventory is
						req_wishlist.send();
					}
				} else {
					// There was a problem with the request.
					// For example, the response may have a 404 (Not Found)
					// or 500 (Internal Server Error) response code.
				}
			} else {
				// Not ready yet.
			}
			// Process the server response here.
		};
		req_inventory.open('GET', '/LipSenseMonitor/rest/inventory');
		req_inventory.send();
	}
</script>
<style>

.eyeball {
fill: #FFFFFF;
fill-opacity: 0;
stroke: #000000;
stroke-width: 5px;
}

.eyelash {
stroke: #000000;
stroke-width: 8px;
stroke-linecap: round;
}

.pupil {
fill: #FFFFFF;
fill-opacity: 0;
stroke: #000000;
stroke-width: 15px;
}

.waiting .pupil {
fill: #FFFF00;
fill-opacity: 0;
stroke: #0000FF;
stroke-width: 15px;
}

.pupil:hover {
fill: #FF00FF;
fill-opacity: 0;
stroke: #00FF00;
stroke-width: 15px;
}

.watcher {
background: url(#open-eye);
}
</style>
</head>
<body>


<svg display="none">
<defs>
<!-- Attempt at a closed eye -->
<symbol id="closed-eye">
    <ellipse class="eyeball" cx="105" cy="55" rx="100" ry="50"/>
    <line class="eyelash" x1="45" y1="75" x2="25" y2="130"/>
    <line class="eyelash" x1="75" y1="83" x2="65" y2="140"/>
    <line class="eyelash" x1="105" y1="90" x2="105" y2="145"/>
    <line class="eyelash" x1="135" y1="83" x2="145" y2="140"/>
    <line class="eyelash" x1="165" y1="75" x2="185" y2="130"/>
    </symbol>
    <!-- Attempt at an open eye -->
<symbol id="open-eye">
    <ellipse class="eyeball" cx="105" cy="90" rx="100" ry="50" />
    <circle class="pupil" cx="105" cy="90" r="20" />
    <line class="eyelash" x1="35" y1="22" x2="45" y2="47"/>
    <line class="eyelash" x1="65" y1="12" x2="75" y2="40"/>
    <line class="eyelash" x1="105" y1="4" x2="105" y2="38"/>
    <line class="eyelash" x1="145" y1="12" x2="135" y2="40"/>
    <line class="eyelash" x1="185" y1="22" x2="165" y2="47"/>
    </symbol>
    </defs>
</svg>

	<div id="distributorSelection">
		Select the Distributor Wishlist: <select id="distributorSelect"></select>
	</div>

	<div id="updated">
		Last updated <span id="updatedTime"></span> ago. (Updates every 30min).
	</div>

	<div id="inventory"></div>

</body>
</html>